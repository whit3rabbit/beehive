# Beehive Manager

A secure and scalable manager service for handling agent tasks and communication.

## Prerequisites

- Go 1.22 or higher
- MongoDB 4.4 or higher
- make (optional, for using Makefile commands)

## Installation & Setup

1. Clone the repository:

```bash
git clone https://github.com/whit3rabbit/beehive/manager
cd manager
```

2. Build the application:

```bash
go build ./cmd/manager
```

This will create a `manager` executable (or `manager.exe` on Windows).

3. Run the setup command. You have two options:

   a. Interactive setup (recommended for first-time setup):

   ```bash
   ./manager setup
   ```

   b. Automatic setup with random secure values:

   ```bash
   ./manager setup --skip
   ```

   The setup command will:
   - Generate SSL certificates in the `certs` directory
   - Create MongoDB user and database
   - Set up the admin user with secure password
   - Create default worker role
   - Generate secure random values for JWT secret and API keys
   - Create the `.env` file with all configurations

## Configuration

The application uses a layered configuration approach, with the following priority (highest to lowest):

1. Command line flags
2. Environment variables
3. `.env` file
4. `config/config.yaml`

### Configuration Files Explained

The application uses two main configuration files that work together:

#### 1. config.yaml

Located at `config/config.yaml`, this file contains the base configuration structure and non-sensitive settings. It can reference environment variables using `${VARIABLE_NAME}` syntax:

```yaml
server:
  host: "0.0.0.0"
  port: 8080
  static_dir: "./frontend/build"
  tls:
    enabled: true
    cert_file: "certs/server.crt"
    key_file: "certs/server.key"

mongodb:
  uri: "${MONGODB_URI}"  # Comes from .env
  database: "manager_db"

auth:
  jwt_secret: "${JWT_SECRET}"          # Comes from .env
  token_expiration_hours: 24
  api_key: "${API_KEY}"                # Comes from .env
  api_secret: "${API_SECRET}"          # Comes from .env

admin:
  default_username: "admin"
  default_password: "${ADMIN_DEFAULT_PASSWORD}"  # Comes from .env
```

#### 2. .env File

Contains sensitive configuration values and secrets. When running with Docker, this file is automatically generated during first startup:

```env
# MongoDB Configuration
MONGO_ROOT_USERNAME=admin
MONGO_ROOT_PASSWORD=generated_password
MONGODB_USER=manager
MONGODB_PASSWORD=generated_password
MONGODB_URI=mongodb://manager:password@mongo:27017/manager_db

# Authentication
JWT_SECRET=generated_secret
API_KEY=generated_key
API_SECRET=generated_secret
ADMIN_DEFAULT_PASSWORD=generated_password

# Other Settings
LOG_LEVEL=info
```

### How Configuration Works

1. During startup:
   - The application first loads `config.yaml`
   - Environment variables are read (including from `.env` file)
   - Environment variables replace any `${VARIABLE_NAME}` placeholders in `config.yaml`
   - Command line flags can override any setting

2. With Docker:
   - The startup script generates secure random values for all credentials
   - These values are saved to `.env` and displayed in logs
   - The values are passed to both the application and MongoDB
   - Subsequent restarts will use the same `.env` file

3. Manual Setup:
   - Running `./manager setup` creates the `.env` file
   - You can modify the generated values as needed
   - The application will use these values on next start

### Environment Variables

Key environment variables:

| Variable | Purpose | Default |
|----------|---------|---------|
| `MONGODB_URI` | MongoDB connection string | Generated from components |
| `MONGODB_DATABASE` | Database name | manager_db |
| `MONGODB_USER` | Application DB user | manager |
| `MONGODB_PASSWORD` | Application DB password | Generated |
| `MONGO_ROOT_USERNAME` | MongoDB admin user | admin |
| `MONGO_ROOT_PASSWORD` | MongoDB admin password | Generated |
| `JWT_SECRET` | JWT signing key | Generated |
| `API_KEY` | Agent API key | Generated |
| `API_SECRET` | Agent API secret | Generated |
| `ADMIN_DEFAULT_PASSWORD` | Admin user password | Generated |

### Configuration Files

#### config.yaml

Located at `config/config.yaml`, this file contains the base configuration:

```yaml
server:
  host: "0.0.0.0"
  port: 8080
  static_dir: "./frontend/build"
  tls:
    enabled: true
    cert_file: "certs/server.crt"
    key_file: "certs/server.key"

mongodb:
  uri: "mongodb://localhost:27017"
  database: "manager_db"

auth:
  jwt_secret: "${JWT_SECRET}"
  token_expiration_hours: 24
  api_key: "${API_KEY}"
  api_secret: "${API_SECRET}"

admin:
  default_username: "admin"
  default_password: "${ADMIN_DEFAULT_PASSWORD}"

logging:
  level: "info"
```

#### .env File

The setup process generates a `.env` file containing sensitive configuration values:

```env
# Server Configuration
# Server Configuration
SERVER_HOST=0.0.0.0
SERVER_PORT=8080
STATIC_DIR=./frontend/build

# MongoDB Configuration
MONGODB_URI=mongodb://user:pass@localhost:27017/dbname
MONGODB_DATABASE=manager_db

# Authentication
JWT_SECRET=<generated-secret>
TOKEN_EXPIRATION_HOURS=24
API_KEY=<generated-key>
API_SECRET=<generated-secret>

# Admin Configuration
ADMIN_DEFAULT_USERNAME=admin
ADMIN_DEFAULT_PASSWORD=<generated-password>

# Logging
LOG_LEVEL=info
```

### Command Line Flags

Available command line flags:

```bash
Usage of ./manager:
  -admin-pass string
        Default admin password
  -admin-user string
        Default admin username
  -config string
        Path to configuration file (default "config/config.yaml")
  -host string
        Server host address
  -jwt-secret string
        JWT secret key
  -log-level string
        Log level (debug, info, warn, error)
  -mongo-db string
        MongoDB database name
  -mongo-uri string
        MongoDB URI
  -port int
        Server port
  -tls
        Enable TLS
  -tls-cert string
        TLS certificate file path
  -tls-key string
        TLS key file path
```

## Running the Server

You can run the server either directly or using Docker.

## Running Directly

After setup, start the server:

```bash
./manager
```

Or with custom configuration:

```bash
./manager -config /path/to/config.yaml
```

## Running with Docker

### Quick Start

```bash
docker-compose up --build
```

This will:

1. Build the application
2. Generate all necessary credentials
3. Initialize MongoDB
4. Start all services

The generated credentials will be displayed in the logs and saved to `.env`. View them with:

```bash
docker logs beehive-manager
# or
cat .env
```

### Providing Custom Credentials

To use your own credentials, set them before starting:

```bash
export MONGO_ROOT_USERNAME=admin
export MONGO_ROOT_PASSWORD=your_root_password
export MONGODB_USER=manager
export MONGODB_PASSWORD=your_app_password
docker-compose up --build
```

### Docker Services

The application runs three services:

- **manager**: The main application server
- **mongo**: MongoDB database
- **nginx**: Reverse proxy for TLS termination

### Container Management

Start containers:

```bash
docker-compose up -d
```

Stop containers:

```bash
docker-compose down
```

View logs:

```bash
# All services
docker-compose logs

# Specific service
docker-compose logs manager
docker-compose logs mongo
docker-compose logs nginx
```

Rebuild and restart a service:

```bash
docker-compose up -d --build manager
```

## Development

### Directory Structure

```
.
├── api/            # API handlers and routes
├── cmd/            # Application entrypoints
├── config/         # Configuration files
├── docs/           # Documentation
├── internal/       # Internal packages
├── middleware/     # HTTP middleware
├── migrations/     # Database migrations
├── models/         # Data models
└── README.md
```

### Build Commands

If you have `make` installed, you can use the following commands:

```bash
# Build the application
make build

# Run tests
make test

# Clean build artifacts
make clean

# Format code
make fmt

# Run linter
make lint

# Generate test coverage
make coverage

# Build for multiple platforms
make build-all
```

## Security Features

- All passwords are hashed using bcrypt
- TLS 1.2+ with secure cipher suites
- Rate limiting on authentication endpoints
- API key and signature-based authentication for agents
- JWT-based authentication for admin routes
- Password policy enforcement
- Automatic cleanup of expired sessions
- HMAC-SHA256 request signing for agent communications

## API Documentation

Detailed API documentation is available in the `docs/api` directory:

- OpenAPI specification: `docs/api/openapi.yaml`
- API Guide: `docs/api/README.md`

## Troubleshooting

### Common Issues

1. **MongoDB Connection Issues**
   - Verify MongoDB is running
   - Check MongoDB connection string in `.env` file
   - Ensure correct credentials are being used

2. **TLS Certificate Issues**
   - Check if certificates exist in the specified path
   - Verify certificate permissions
   - Run setup again to regenerate certificates

3. **Permission Issues**
   - Ensure proper file permissions on config files
   - Check MongoDB user permissions
   - Verify TLS certificate file permissions

For any other issues, check the logs (default location: stdout) with the configured log level.
